AWSTemplateFormatVersion: 2010-09-09
Description: Master Template for the ECS RPC Service
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: Network configuration
        Parameters:
          - VPC
          - Subnets
          - CIDR
          - Bandwidth
          - BandwidthCeiling
      -
        Label:
          default: Cluster options
        Parameters:
          - ClusterSize
          - SpotPrice
          - InstanceType
          - KeyPair
    ParameterLabels:
      ClusterSize:
        default: Cluster size
      SpotPrice:
        default: Spot price
      InstanceType:
        default: Instance type
      KeyPair:
        default: Key pair
Parameters:
  EnvironmentName:
    Description: An environment name that will be prefixed to resource names
    Type: String
  SpotPrice:
    Description: What is the maximum spot price we should pay per instance?  Set this to the on-demand price normally.
    Type: Number
    Default: 0.156
  ClusterSize:
    Description: How many ECS hosts do you want to initially deploy?
    Type: Number
    Default: 3
  VPC:
    Description: Choose which VPC this ECS cluster should be deployed to
    Type: AWS::EC2::VPC::Id
  Subnets:
    Description: Choose which subnets this ECS cluster should be deployed to
    Type: String
  CIDR:
    Description: CIDR range that you will allow JSON RPC requests from (leave default if using default VPC)
    Type: String
    Default: "172.31.0.0/16"
  KeyPair:
    Description: Select the KeyPair that you would like to use for the ECS cluster hosts
    Type: AWS::EC2::KeyPair::KeyName
  Bandwidth:
    Description: How much bandwidth, in kb/sec., should be allocated to Parity peers (upload) per EC2 instance
    Type: Number
    Default: 2048
  BandwidthCeiling:
    Description: How much bandwidth, in kb/sec., should be allocated to Parity peers as a ceiling (max. upload)
    Type: Number
    Default: 4096
  InstanceType:
    Description: The type of compute instance to use for your RPC nodes.
    Default: i3.xlarge
    Type: String
    AllowedValues:
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.8xlarge
Resources:
  EcsCluster:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/ecs-rpc-service-templates-<%= suffix %>/ecs-cluster.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        SpotPrice: !Ref SpotPrice
        ClusterSize: !Ref ClusterSize
        VPC: !Ref VPC
        Subnets: !Ref Subnets
        CIDR: !Ref CIDR
        KeyPair: !Ref KeyPair
        Bandwidth: !Ref Bandwidth
        BandwidthCeiling: !Ref BandwidthCeiling
        InstanceType: !Ref InstanceType
